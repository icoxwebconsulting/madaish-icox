var app=angular.module("madaish",["ionic","ionic.cloud","ngResource"]);app.run(function($ionicPlatform){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}),app.constant("GLOBAL",{categories:[{tag:"Moda",title:"Moda",subtitle:"Tendencias, shopping"},{tag:"Belleza",title:"Belleza",subtitle:"Tips, productos, tutoriales"},{tag:"Lifestyle",title:"Lifestyle",subtitle:"Amor, amigas, viajes"},{tag:"Looks",title:"Looks",subtitle:"Encuentra inspiración"},{tag:"Videos",title:"Videos",subtitle:"Moda, belleza, estilo de vida"}]}),app.constant("API",{url:"http://madaishapi.azurewebsites.net/api/",image:{user:{path:"https://madaishuploads.blob.core.windows.net/users/"}}}),app.config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$stateProvider.state("base",{url:"/",abstract:!0,templateUrl:"templates/base.html"}).state("base.timeline",{url:"timeline",views:{timeline:{templateUrl:"templates/timeline/main.html",controller:"TimelineController"}}}).state("base.explorer",{url:"explorer",views:{explorer:{templateUrl:"templates/explorer/main.html",controller:"ExplorerController"}}}),$urlRouterProvider.otherwise("/timeline"),$ionicConfigProvider.views.maxCache(0)}),app.controller("BaseController",function($scope,$state){}),app.controller("ExplorerController",function($scope,GLOBAL,PostService){$scope.init=function(){$scope.categories=GLOBAL.categories,$scope.posts=[],PostService.resource.getExplorer().$promise.then(function(data){console.info("posts",data.Posts)})},$scope.init()}),app.controller("PostCardController",function($scope,GLOBAL,UtilsService,PostService){var post=$scope.data,user=$scope.data.Profile,currentUser=userService.getCurrentUser(),waitForDoubleClick=null;switch($scope.getImageUrl=function(image){return UtilsService.getImageUrl(apiService.userImagePath,image)},$scope.showPost=function(){if(!$scope.content){var delay=$scope.data.isLiked||!$scope.data.Image?0:300;waitForDoubleClick=$timeout(function(){waitForDoubleClick=null,$state.go("root.view.post",{content:1==post.ContentType?"look":"post",userName:post.Profile.FriendlyUrlUserName,postName:post.FriendlyUrlTitle})},delay)}},$scope.doubleClick=function($event){$scope.data.isLiked||$timeout.cancel(waitForDoubleClick)&&($scope.like(),$event.stopPropagation())},$scope.like=function(){if(!$scope.data.isLiked){var type=1==post.ContentType?"Look":"Post";return userService.askForLogin().then(function(){return userService.checkLike(post.Id,!0).then(function(){return apiService.getUser(post.Profile.FriendlyUrlUserName,!0),apiService.like(type,post.Id)})})}},$scope.delete=function(){if(confirm("Eliminar esta publicación. ¿Está seguro?")){var endpoint=1==post.ContentType?apiService.deleteLook:apiService.deletePost,request=endpoint(post.Id).then(function(){userService.checkCurrentUser().then(function(currentUser){apiService.getUser(currentUser.FriendlyUrlUserName,!0),$scope.$root.$emit("profile.update"),$state.go("root.tabs.profile")})});utilsService.showSpinner(!0,request)}},$scope.type){case"post":$scope.subtitle=post.Type,$scope.content=post.Text,$scope.video=post.Video,$scope.widget="follow";break;case"look":$scope.subtitle=post.Category.Name,$scope.content=post.Text||post.Description,$scope.widget="follow";break;default:!post.Image&&post.Text&&($scope.data.Image=(post.Text.match(/\<img\s+src\s*\=\s*\"([^\"]+)\"/i)||[])[1]),$scope.subtitle=utilsService.filter("amTimeAgo",post.PublishDate),$scope.content="",$scope.widget=""}currentUser.FriendlyUrlUserName==user.FriendlyUrlUserName&&($scope.widget="ion-trash-b",$scope.callback=$scope.delete),userService.checkLike(post.Id).then(function(liked){return liked?void($scope.data.isLiked=!0):$q.reject()}).catch(function(){$scope.$root.$on("liked_"+post.Id,function(){$scope.data.LikesCount++,$scope.data.isLiked=!0})})}),app.controller("TimelineController",function($scope){$scope.init=function(){$scope.page=1,$scope.posts=[]};$scope.reload=function(){$scope.page=0,apiService.getTimeline(!0).then(function(){$scope.page=1,$scope.cards=[],$ionicScrollDelegate.resize()}).finally(function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.nextPage=function(prefetch){apiService.getTimeline(!1,$scope.page).then(function(cards){return cards.length?void(prefetch||(addCards(cards),$scope.page++,$scope.nextPage(!0),$scope.$broadcast("scroll.infiniteScrollComplete"))):$scope.page=0})}}),app.directive("postCard",function(){return{restrict:"E",scope:{type:"@",data:"<"},controller:"postCardController",templateUrl:"post/card.html"}}),app.factory("PostService",function($resource,API){var resource=$resource(API.url,{},{getExplorer:{method:"GET",isArray:!1,url:API.url+"/xplora/getxplora"}});return{resource:resource}}),app.service("UtilsService",function($window,$q,$timeout,$ionicLoading,$filter,$ionicHistory,$state,API){var service=this;this.NO_DELAY=0,this.FEEDBACK_DELAY=1e3;var spinnerRequests=0,syncSpinner=$q.defer();this.showSpinner=function(when,until){var show=$q.defer(),start="number"==typeof when?$timeout(when):$q.resolve(when),stop=until?$q.resolve(until):syncSpinner.promise;start.then(show.resolve),stop.finally(show.reject),show.promise.then(function(){++spinnerRequests,$ionicLoading.show({template:"Cargando..."}),stop.finally(function(){--spinnerRequests||$ionicLoading.hide()})})},this.hideSpinner=function(){syncSpinner.resolve(),syncSpinner=$q.defer()},this.filter=function(filterName,input,params){var args=[input].concat(params||[]);return $filter(filterName).apply(input,args)},this.parseUrl=function(url){if(!url)return null;var parsed=document.createElement("a");parsed.href=url;var external=/^(https?:)?\/\//i,resource=/(.+)\/(.+)\.(.+)$/i,post=/^\/(.+)\/(.+)$/,look=/^\/(.+)\/looks\/(.+)$/i;return url.match(external)?{type:"external",protocol:parsed.protocol,hostname:parsed.hostname,port:parsed.port,pathname:parsed.pathname,search:parsed.search,hash:parsed.hash}:(match=parsed.pathname.match(resource))?{type:"resource",path:match[1],filename:match[2],extension:match[3]}:(match=parsed.pathname.match(post))?{type:"post",username:match[1],postname:match[2]}:(match=parsed.pathname.match(look))?{type:"look",username:match[1],lookname:match[2]}:{type:"unknown"}},this.getImageUrl=function(image,defaultSrc){return image?"external"==service.parseUrl(image).type?image:API.image.user.path+image:defaultSrc},this.openExternalLink=function(url){return window.open(url,"_system")},this.goBack=function(){service.showSpinner(),"root.view.followers"==$state.current.name||"root.view.follows"==$state.current.name?($state.go(service.lastState),service.hideSpinner()):($ionicHistory.backView()?$ionicHistory.goBack():$state.go("root.dispatcher"),service.hideSpinner())},this.lastState=null,this.setLastView=function(state){service.lastState=state},this.restart=function(){$state.go("root.tabs.timeline")}});
var app=angular.module("madaish",["ionic","ionic.cloud","ngResource","ngStorage","angularMoment"]);app.run(function($rootScope,$ionicPlatform,$state){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){switch(console.info("catch error"),error){case"not-logged":event.preventDefault(),$state.go("base.login");break;case"logged":event.preventDefault(),$state.go("base.timeline")}})})}),app.constant("GLOBAL",{categories:[{tag:"Moda",title:"Moda",subtitle:"Tendencias, shopping"},{tag:"Belleza",title:"Belleza",subtitle:"Tips, productos, tutoriales"},{tag:"Lifestyle",title:"Lifestyle",subtitle:"Amor, amigas, viajes"},{tag:"Looks",title:"Looks",subtitle:"Encuentra inspiración"},{tag:"Videos",title:"Videos",subtitle:"Moda, belleza, estilo de vida"}]}),app.constant("API",{url:"http://madaishapi.azurewebsites.net/api/",image:{user:{path:"https://madaishuploads.blob.core.windows.net/users/"}}}),app.config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$stateProvider.state("base",{url:"/",abstract:!0,templateUrl:"templates/base.html"}).state("base.login",{url:"login",views:{timeline:{templateUrl:"templates/user/login/main.html",controller:"LoginController",resolve:{auth:function(UserService,$q){if(UserService.isLogged())return $q.reject("logged")}}}}}).state("base.login-email",{url:"login/email",views:{timeline:{templateUrl:"templates/user/login/email.html",controller:"LoginController",resolve:{auth:function(UserService,$q){if(UserService.isLogged())return $q.reject("logged")}}}}}).state("base.timeline",{url:"timeline",views:{timeline:{templateUrl:"templates/timeline/main.html",controller:"TimelineController",resolve:{auth:function(UserService,$q){if(!UserService.isLogged())return $q.reject("not-logged")}}}}}).state("base.explorer",{url:"explorer",views:{explorer:{templateUrl:"templates/explorer/main.html",controller:"ExplorerController"}}}),$urlRouterProvider.otherwise("/timeline")}),app.controller("BaseController",function($scope,$state){}),app.controller("ExplorerController",function($scope,GLOBAL,PostService){$scope.loadPosts=function(){PostService.resource.getExplorer({page:$scope.page}).$promise.then(function(data){data.Posts&&($scope.posts=$scope.posts.concat(data.Posts)),data.Looks&&($scope.posts=$scope.posts.concat(data.Looks)),data.Posts||data.Looks||($scope.page=null)}).finally(function(){$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.init=function(){$scope.categories=GLOBAL.categories,$scope.posts=[],$scope.page=1,$scope.loadPosts()},$scope.init(),$scope.loadMore=function(){$scope.page++,$scope.loadPosts()}}),app.controller("LoginController",function($scope,$state,AuthService,UserService,UtilsService){if($scope.init=function(){$scope.choice=""},$scope.init(),"base.login-email"==$state.current.name&&($scope.login={},$scope.login.valid=!1,$scope.login.forgotPassword=!1,$scope.$watch("login",function(){var l=$scope.login;l.valid=l.email&&(l.password||l.forgotPassword)},!0),$scope.emailLogin=function(){var user=new AuthService.resource;user.username=$scope.login.email,user.password=$scope.login.password,UtilsService.showSpinner(),user.$login(function(response){response.Success?(UtilsService.hideSpinner(),response.CurrentUser.FriendlyUrlUserName=response.CurrentUser.FriendlyUrlName,response.CurrentUser.UserId=response.CurrentUser.Id,response.CurrentUser.Token=response.Token,console.info("response",response),UserService.setUser(response.CurrentUser),$state.go("base.timeline")):(UtilsService.hideSpinner(),UtilsService.showAlert("Datos invalidos"))},function(error){return UtilsService.hideSpinner(),UtilsService.showAlert("Error en conexion"),!1})}),"base.login"==$state.current.name){var fbLoginSuccess=function(response){if(!response.authResponse)return void fbLoginError("Cannot find the authResponse");var authResponse=response.authResponse;getFacebookProfileInfo(authResponse).then(function(profileInfo){apiService.loginFromFB(profileInfo).then(function(response){return console.info("not connected",response),$state.go("root.tabs.profile"),$timeout(function(){$ionicLoading.hide()},3e3),userService.setCurrentUser(response)}).catch(function(error){utilsService.hideSpinner(),$scope.loading=!1,$ionicLoading.hide()})},function(fail){console.log("profile info fail",fail)})},fbLoginError=function(error){console.log("fbLoginError",error),$ionicLoading.hide()},getFacebookProfileInfo=function(authResponse){var info=$q.defer();return facebookConnectPlugin.api("/me?fields=email,name&access_token="+authResponse.accessToken,null,function(response){console.log(response),info.resolve(response)},function(response){console.log(response),info.reject(response)}),info.promise};$scope.facebookLogin=function(){facebookConnectPlugin.getLoginStatus(function(success){"connected"===success.status?getFacebookProfileInfo(success.authResponse).then(function(profileInfo){apiService.loginFromFB(profileInfo).then(function(response){return $state.go("root.tabs.profile"),$timeout(function(){$ionicLoading.hide()},3e3),userService.setCurrentUser(response)}).catch(function(error){utilsService.hideSpinner(),$scope.loading=!1,$ionicLoading.hide()})},function(fail){console.log("profile info fail",fail)}):($ionicLoading.show({template:"Iniciando ..."}),facebookConnectPlugin.login(["email","public_profile"],fbLoginSuccess,fbLoginError))})}}}),app.controller("PostCardController",function($scope,$timeout,GLOBAL,UtilsService,UserService,PostService){var post=$scope.data,user=$scope.data.Profile,waitForDoubleClick=null,currentUser=UserService.getUser;switch($scope.getImageUrl=function(image){return UtilsService.getImageUrl(image)},$scope.showPost=function(){if(!$scope.content){var delay=$scope.data.isLiked||!$scope.data.Image?0:300;waitForDoubleClick=$timeout(function(){waitForDoubleClick=null,$state.go("root.view.post",{content:1==post.ContentType?"look":"post",userName:post.Profile.FriendlyUrlUserName,postName:post.FriendlyUrlTitle})},delay)}},$scope.doubleClick=function($event){$scope.data.isLiked||$timeout.cancel(waitForDoubleClick)&&($scope.like(),$event.stopPropagation())},$scope.like=function(){if(!$scope.data.isLiked){if(UserService.isLogged()){var currentPost=new PostService.resource;return currentPost.type=1==post.ContentType?"Look":"Post",currentPost.id=post.Id,currentPost.$setLike(function(response){return response},function(error){return UtilsService.hideSpinner(),UtilsService.showAlert("Error en conexion"),!1})}UtilsService.showAlert("Por favor inicie sesion para dar me gusta")}},$scope.delete=function(){if(confirm("Eliminar esta publicación. ¿Está seguro?")){var endpoint=1==post.ContentType?apiService.deleteLook:apiService.deletePost,request=endpoint(post.Id).then(function(){userService.checkCurrentUser().then(function(currentUser){apiService.getUser(currentUser.FriendlyUrlUserName,!0),$scope.$root.$emit("profile.update"),$state.go("root.tabs.profile")})});utilsService.showSpinner(!0,request)}},$scope.type){case"post":$scope.subtitle=post.Type,$scope.content=post.Text,$scope.video=post.Video,$scope.widget="follow";break;case"look":$scope.subtitle=post.Category.Name,$scope.content=post.Text||post.Description,$scope.widget="follow";break;default:!post.Image&&post.Text&&($scope.data.Image=(post.Text.match(/\<img\s+src\s*\=\s*\"([^\"]+)\"/i)||[])[1]),$scope.subtitle=UtilsService.filter("amTimeAgo",post.PublishDate),$scope.content="",$scope.widget=""}null!=user&&currentUser.FriendlyUrlUserName==user.FriendlyUrlUserName&&($scope.widget="ion-trash-b",$scope.callback=$scope.delete)}),app.controller("ProfileController",function($scope,GLOBAL,PostService){$scope.init=function(){$scope.user=""},$scope.init()}),app.controller("SearchController",function($scope,GLOBAL,PostService){$scope.init=function(){$scope.criteria=""},$scope.init()}),app.controller("TimelineController",function($scope,PostService){$scope.loadPosts=function(){PostService.resource.getTimeline({page:$scope.page}).$promise.then(function(data){var posts=[];data.Items.forEach(function(card){posts.push({Profile:{UserId:card.CreatorId,UserName:card.CreatorUserName,FriendlyUrlUserName:card.CreatorUserFriendlyUrlName,Avatar:card.CreatorAvatar},Id:card.ContentId,ContentType:card.ContentType,Type:card.ContentCategory,Title:card.ContentTitle,FriendlyUrlTitle:card.ContentFriendlyUrlTitle,IntroText:card.ContentResume,Text:card.ContentFull,Image:card.ContentImage,LikesCount:card.LikesCount,PublishDate:card.PublishDate,IsFast:card.IsFast})}),console.info("posts",posts),$scope.posts=$scope.posts.concat(posts),data.ShowMore||($scope.page=null)}).finally(function(){$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.init=function(){$scope.posts=[],$scope.page=1,$scope.loadPosts()},$scope.init(),$scope.loadMore=function(){$scope.page++,$scope.loadPosts()}}),app.factory("AuthService",function($resource,API,$localStorage){var resource=$resource(API.url,{},{login:{method:"POST",isArray:!1,url:API.url+"Account/login"},facebookSignIn:{method:"GET",isArray:!1,url:API.url+"Account/fblogin"}});return{resource:resource}}),app.factory("NotificationService",function($resource,API,$localStorage){var resource=$resource(API.url,{},{createDevice:{method:"POST",isArray:!1,url:API.url+"Notification/SaveDevice"},deleteDevice:{method:"POST",isArray:!1,url:API.url+"Notification/RemoveDevice"}});return{resource:resource}}),app.factory("PostService",function($resource,API,UserService){var resource=$resource(API.url,{},{getTimeline:{method:"GET",isArray:!1,headers:{token:UserService.getUser().Token||null},url:API.url+"social/gettimeline"},getExplorer:{method:"GET",isArray:!1,url:API.url+"xplora/getxplora"},setLike:{method:"POST",isArray:!1,url:API.url+"likes/like"}});return{resource:resource}}),app.factory("UserService",function($resource,API,$localStorage,$ionicPush,NotificationService){function isLogged(){return"undefined"!=typeof $localStorage.user&&"undefined"!=typeof $localStorage.user.Token}function getUser(){return $localStorage.user||{}}function getUserId(){return isLogged()?getUser().id:0}function notificationActive(){return!!isLogged()&&getUser().notification}function setUser(user){$localStorage.user=user,registerDevice(user.Id)}function logout(){var data={};data.access_token=$localStorage.user.access_token,data.device_token=$localStorage.device_token,data.os=$localStorage.os,unRegisterDevice(data).then(function(response){$localStorage.user={},$state.go("base.login")})}function validateEmail(email){var pattern=/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;return pattern.test(email)}function unRegisterDevice(data){var deferred=$q.defer(),deviceResource=new DeviceService.resource;return deviceResource.$unRegister({access_token:data.access_token,device_token:data.device_token},function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}function registerDevice(userId){return $ionicPush.register().then(function(t){return $ionicPush.saveToken(t)}).then(function(t){console.log("Token saved:",t.token);var os="0";ionic.Platform.isIOS()&&(os="1"),$localStorage.device_token=t.token,$localStorage.os=os;var notification=new NotificationService.resource;notification.user_id=userId,notification.os=os,notification.device_token=t.token,notification.$createDevice(function(response){return!0},function(error){return!1})})}var resource=$resource(API.url,{},{getExplorer:{method:"GET",isArray:!1,url:API.url+"/xplora/getxplora"}});return{resource:resource,isLogged:isLogged,validateEmail:validateEmail,getUser:getUser,getUserId:getUserId,setUser:setUser,logout:logout,registerDevice:registerDevice,unRegisterDevice:unRegisterDevice,notificationActive:notificationActive}}),app.service("UtilsService",function($window,$q,$timeout,$ionicLoading,$ionicPopup,$filter,$ionicHistory,$state,API){var service=this;this.showSpinner=function(){$ionicLoading.show({template:"Cargando..."})},this.hideSpinner=function(){$ionicLoading.hide()},this.showAlert=function(message){$ionicPopup.alert({title:message})},this.filter=function(filterName,input,params){var args=[input].concat(params||[]);return $filter(filterName).apply(input,args)},this.parseUrl=function(url){if(!url)return null;var parsed=document.createElement("a");parsed.href=url;var external=/^(https?:)?\/\//i,resource=/(.+)\/(.+)\.(.+)$/i,post=/^\/(.+)\/(.+)$/,look=/^\/(.+)\/looks\/(.+)$/i;return url.match(external)?{type:"external",protocol:parsed.protocol,hostname:parsed.hostname,port:parsed.port,pathname:parsed.pathname,search:parsed.search,hash:parsed.hash}:(match=parsed.pathname.match(resource))?{type:"resource",path:match[1],filename:match[2],extension:match[3]}:(match=parsed.pathname.match(post))?{type:"post",username:match[1],postname:match[2]}:(match=parsed.pathname.match(look))?{type:"look",username:match[1],lookname:match[2]}:{type:"unknown"}},this.getImageUrl=function(image,defaultSrc){return image?"external"==service.parseUrl(image).type?image:API.image.user.path+image:defaultSrc},this.openExternalLink=function(url){return window.open(url,"_system")},this.goBack=function(){service.showSpinner(),"root.view.followers"==$state.current.name||"root.view.follows"==$state.current.name?($state.go(service.lastState),service.hideSpinner()):($ionicHistory.backView()?$ionicHistory.goBack():$state.go("root.dispatcher"),service.hideSpinner())},this.lastState=null,this.setLastView=function(state){service.lastState=state},this.restart=function(){$state.go("root.tabs.timeline")}}),app.directive("postCard",function(){return{restrict:"E",scope:{type:"@",data:"<"},controller:"PostCardController",templateUrl:"templates/post/card.html"}});